<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Создание Gps Трека</title>
    <!--Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://getbootstrap.com/docs/5.3/assets/css/docs.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
</head>
<body>

<div class="container mt-4">
    <h2>Создание GPS Трека</h2>
    <form id="trackForm">
        <div id="coordinatesContainer">
        </div>

        <button type="button" class="btn btn-success mt-3" onclick="submitCoordinates()">Отправить</button>
    </form>

    <div id="output" class="mt-3"></div>
</div>

<script>
    // Массив для хранения объектов Coordinate (в виде {lat: "...", lon: "..."})
    let coordinates = [];
    // Счетчик для генерации уникальных ID
    let rowIndex = 0;
    // Функция для добавления новой строки
    function addRow(latValue = '', lonValue = '') {
        rowIndex++;
        const container = document.getElementById('coordinatesContainer');
        const rowDiv = document.createElement('div');
        rowDiv.className = 'row mb-3';
        rowDiv.id = `row-${rowIndex}`; // Уникальный ID для строки

        rowDiv.innerHTML = `
            <div class="col-md-5">
                <label for="lat${rowIndex}" class="form-label">Широта ${rowIndex}</label>
                <input type="text" class="form-control" id="lat${rowIndex}" name="lat${rowIndex}" placeholder="Широта ${rowIndex}" value="${latValue}">
            </div>
            <div class="col-md-5">
                <label for="lon${rowIndex}" class="form-label">Долгота ${rowIndex}</label>
                <input type="text" class="form-control" id="lon${rowIndex}" name="lon${rowIndex}" placeholder="Долгота ${rowIndex}" value="${lonValue}">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="button" class="btn btn-primary w-100" onclick="addCoordinate(${rowIndex})">Добавить</button>
                <button type="button" class="btn btn-danger w-100 mt-1" onclick="removeRow(${rowIndex})">Удалить</button>
            </div>
        `;
        container.appendChild(rowDiv);
    }

    // Функция для добавления координаты из строки и создания новой строки
    function addCoordinate(index) {
        const latInput = document.getElementById(`lat${index}`);
        const lonInput = document.getElementById(`lon${index}`);
        const latValue = latInput.value.trim();
        const lonValue = lonInput.value.trim();
        if (latValue && lonValue) {
            // Добавляем объект с lat и lon (в виде строк)
            coordinates.push({lat: latValue, lon: lonValue});
            console.log("Добавлена координата:", {lat: latValue, lon: lonValue});
            // Очищаем поля ввода после добавления
            // latInput.value = ''; // <-- УБРАНО: значение остается
            // lonInput.value = ''; // <-- УБРАНО: значение остается
            // Создаем новую строку с пустыми значениями
            addRow(); // Добавляем новую пустую строку
        } else {
            alert(`Пожалуйста, заполните оба поля для строки ${index}.`);
        }
    }

    // Функция для удаления строки
    function removeRow(index) {
        const rowElement = document.getElementById(`row-${index}`);
        if (rowElement) {
            rowElement.remove();
        }
    }

    // Функция для отправки координат на сервер
    function submitCoordinates() {
        // Собираем все непустые координаты из текущих строк
        coordinates = []; // Очищаем массив
        const container = document.getElementById('coordinatesContainer');
        const rows = container.querySelectorAll('.row'); // Находим все строки
        rows.forEach(row => {
            // Находим input-ы внутри строки
            const latInput = row.querySelector('input[id^="lat"]');
            const lonInput = row.querySelector('input[id^="lon"]');

            if (latInput && lonInput) {
                const latValue = latInput.value.trim();
                const lonValue = lonInput.value.trim();

                if (latValue && lonValue) {
                    coordinates.push({lat: latValue, lon: lonValue});
                }
            }
        });
        if (coordinates.length < 4) {
            alert(`Пожалуйста, добавьте не менее 4 координат. Сейчас: ${coordinates.length}.`);
            return;
        }
        // Отправляем все собранные координаты
        const coordinatesToSend = coordinates;
        // Отправляем POST-запрос с JSON-телом
        fetch('/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json' // Указываем, что отправляем JSON
            },
            // Сериализуем массив объектов Coordinate в JSON-строку
            body: JSON.stringify(coordinatesToSend)
        })
            .then(response => {
                if (!response.ok) {
                    // Получаем текст ошибки, если запрос неуспешен (например, 500)
                    // Это поможет увидеть сообщение об ошибке от сервера, если он вернул HTML
                    return response.text().then(text => {
                        // Выводим HTML ошибки в консоль для отладки
                        console.error("Ответ сервера с ошибкой (HTML):", text);
                        // Выбрасываем новую ошибку с информацией о статусе
                        throw new Error(`Сервер вернул ошибку: ${response.status} ${response.statusText}`);
                    });
                }
                // Если запрос успешен, ожидаем бинарные данные (blob)
                // Это соответствует возвращаемому типу byte[] из контроллера Spring
                return response.blob();
            })
            .then(blob => {
                // Создаем URL для blob-объекта
                const downloadUrl = window.URL.createObjectURL(blob);
                // Создаем временный элемент <a> для скачивания
                const link = document.createElement('a');
                link.href = downloadUrl;
                // Указываем имя файла, которое будет предложено для скачивания
                link.download = 'track.gpx'; // или динамически сгенерировать имя, если нужно
                // Добавляем ссылку в DOM, симулируем клик и удаляем её
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                // Освобождаем созданный URL, чтобы освободить память
                window.URL.revokeObjectURL(downloadUrl);
                console.log('Файл успешно получен и предложен для скачивания.');
                document.getElementById('output').innerHTML = '<div class="alert alert-success">Файл успешно создан и предложен для скачивания!</div>';
                // Очищаем массив координат после успешной отправки и получения файла
                coordinates = [];
                // Очищаем контейнер с полями ввода
                document.getElementById('coordinatesContainer').innerHTML = '';
                // Сбрасываем счётчик
                rowIndex = 0;
                // Добавляем первую строку снова
                addRow();
            })
            .catch(error => {
                // Обработка любых ошибок (сетевых, JSON.parse, логики внутри .then и т.д.)
                console.error('Ошибка при отправке или обработке ответа:', error);
                // Отображаем сообщение об ошибке пользователю
                document.getElementById('output').innerHTML = '<div class="alert alert-danger">Ошибка: ' + error.message + '</div>';
            });
    }
    // Добавляем первую строку при загрузке страницы
    document.addEventListener('DOMContentLoaded', function () {
        addRow();
    });
</script>

</body>
</html>